import streamlit as st
import fitz  # PyMuPDF
import tempfile
import os

# ========== PDF Okuma Fonksiyonu ==========
def extract_text_and_images(pdf_file):
    doc = fitz.open(pdf_file)
    text = ""
    images = []

    for page_num in range(len(doc)):
        page = doc[page_num]
        text += page.get_text()

        for img_index, img in enumerate(page.get_images(full=True)):
            xref = img[0]
            base_image = doc.extract_image(xref)
            image_bytes = base_image["image"]
            images.append(image_bytes)

    doc.close()
    return text, images

# ========== GÃ¶rsel "Ã–ÄŸrenme" Fonksiyonu (Placeholder) ==========
def analyze_images(images):
    return [f"Image {i+1}: GÃ¶rsel analiz placeholder aÃ§Ä±klamasÄ±." for i in range(len(images))]

# ========== Fenotip Analizi ==========
def analyze_phenotype(phenotype_description, pdf_text):
    # PDF'teki metin kullanÄ±larak basit Ã¶rnek Ã¶neri dÃ¶ndÃ¼rÃ¼lÃ¼r
    return f"Verilen fenotip: {phenotype_description}\n\nKaynak PDF'ten olasÄ± tanÄ±: 'Ã–rnek TanÄ± (placeholder)'"

# ========== Rapor Ãœretme ==========
def generate_report(phenotype_result, image_analysis):
    report = "=== OlasÄ± TanÄ± Raporu ===\n\n"
    report += phenotype_result + "\n\n"
    report += "=== GÃ¶rsel Analiz ===\n"
    for desc in image_analysis:
        report += desc + "\n"
    return report

# ========== Streamlit ArayÃ¼zÃ¼ ==========
st.title("ğŸ§¬ PDF Destekli Medikal TanÄ± YardÄ±m AsistanÄ±")

uploaded_pdf = st.file_uploader("PDF dosyasÄ±nÄ± yÃ¼kleyin", type=["pdf"])

if uploaded_pdf:
    with tempfile.NamedTemporaryFile(delete=False, suffix=".pdf") as tmp_file:
        tmp_file.write(uploaded_pdf.read())
        tmp_path = tmp_file.name

    pdf_text, images = extract_text_and_images(tmp_path)

    st.subheader("PDF Metni (Ä°lk 2000 karakter):")
    st.write(pdf_text[:2000] + "...")

    st.subheader("PDF GÃ¶rselleri:")
    for img_bytes in images:
        st.image(img_bytes)

    st.success("PDF baÅŸarÄ±yla okundu ve analiz iÃ§in hazÄ±r.")

    phenotype_description = st.text_area("Fenotip (Ã¶r: unilateral kraniosinostoz, klinodaktili, kalp defekti)", "")

    if st.button("Analizi BaÅŸlat"):
        image_analysis = analyze_images(images)
        phenotype_result = analyze_phenotype(phenotype_description, pdf_text)
        report = generate_report(phenotype_result, image_analysis)

        st.subheader("ğŸ” SonuÃ§ Raporu")
        st.text_area("Rapor", report, height=400)
        st.download_button("ğŸ“„ Raporu Ä°ndir", report, file_name="tani_raporu.txt")

    os.unlink(tmp_path)
